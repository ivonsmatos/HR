<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SyncRH" />
    <meta name="theme-color" content="#3B82F6" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/api/pwa/manifest/" />

    <!-- App Icons -->
    <link rel="apple-touch-icon" href="/static/images/icons/icon-192x192.png" />
    <link
      rel="icon"
      type="image/png"
      href="/static/images/icons/icon-96x96.png"
    />

    <!-- Windows Tiles -->
    <meta name="msapplication-config" content="/api/pwa/browserconfig/" />

    <!-- Splash Screen (iOS) -->
    <link
      rel="apple-touch-startup-image"
      href="/static/images/splash/splash-1125x2436.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/static/images/splash/splash-1242x2208.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"
    />

    <!-- PWA Security -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta
      name="description"
      content="Enterprise ERP System - Multi-tenant SaaS"
    />
    <meta name="keywords" content="ERP, SaaS, Enterprise, Management" />

    <!-- PWA Styles -->
    <style>
      :root {
        --primary-color: #3b82f6;
        --error-color: #ef4444;
        --success-color: #10b981;
        --warning-color: #f59e0b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      body {
        background: #fff;
        color: #333;
      }

      /* Safe area insets for notched devices */
      @supports (padding: max(0px)) {
        body {
          padding-left: max(12px, env(safe-area-inset-left));
          padding-right: max(12px, env(safe-area-inset-right));
          padding-top: max(12px, env(safe-area-inset-top));
          padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
      }

      #app {
        height: 100%;
        width: 100%;
      }

      /* Loading indicator */
      .pwa-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #f9fafb;
      }

      .pwa-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Online indicator */
      #online-indicator {
        position: fixed;
        top: env(safe-area-inset-top, 10px);
        right: env(safe-area-inset-right, 10px);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        z-index: 9999;
        transition: all 0.3s ease;
      }

      #online-indicator.online {
        background: var(--success-color);
        color: white;
      }

      #online-indicator.offline {
        background: var(--error-color);
        color: white;
      }

      /* PWA Notification */
      #pwa-notification {
        position: fixed;
        bottom: env(safe-area-inset-bottom, 10px);
        right: env(safe-area-inset-right, 10px);
        z-index: 9998;
      }

      .pwa-update-notification {
        background: var(--primary-color);
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Install button */
      #install-app-btn {
        display: none;
        padding: 12px 24px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      #install-app-btn:hover {
        background: #2563eb;
      }

      #install-app-btn:active {
        background: #1d4ed8;
      }

      /* Responsive */
      @media (max-width: 640px) {
        body {
          padding-left: 8px;
          padding-right: 8px;
          padding-top: 8px;
          padding-bottom: 8px;
        }
      }
    </style>

    <title>SyncRH</title>
  </head>
  <body>
    <!-- Skip Navigation Links (Acessibilidade) -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-[#274B59] text-[#D0E5F2] px-4 py-2 rounded z-50">
      Pular para conteúdo principal
    </a>
    <a href="#navigation" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:top-16 bg-[#274B59] text-[#D0E5F2] px-4 py-2 rounded z-50">
      Pular para navegação
    </a>

    <!-- Main app container -->
    <div id="app">
      <div class="pwa-loading">
        <div class="pwa-loading-spinner"></div>
      </div>
    </div>

    <!-- PWA Notification container -->
    <div id="pwa-notification"></div>

    <!-- Install App Button (shown by PWA) -->
    <button id="install-app-btn">Instalar App</button>

    <!-- PWA Scripts -->
    <script src="/static/js/pwa.js" defer></script>

    <!-- Accessibility Enhancements -->
    <script src="/static/js/accessibility.js" defer></script>

    <!-- Your main app script -->
    <script src="/static/js/app.js" defer></script>

    <!-- CSRF Token for Django forms -->
    <script>
      const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      };

      window.csrf_token = getCookie("csrftoken");

      // Fetch wrapper for API calls
      window.apiCall = async (url, options = {}) => {
        const headers = {
          "Content-Type": "application/json",
          "X-CSRFToken": window.csrf_token,
          ...options.headers,
        };

        const response = await fetch(url, {
          ...options,
          headers,
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        return response.json();
      };
    </script>

    <!-- Helix Chat Widget Injection (FASE D) -->
    {% if request.user.is_authenticated and helix.status %}
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Chat Widget Container -->
    <div id="helix-chat-widget">
      {% include "assistant/partials/chat_bubble.html" with conversation=helix.current_conversation ollama_available=helix.ollama_available %}
    </div>

    <!-- Widget Styles -->
    <style>
      /* Helix Chat Widget Global Styles */
      #helix-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      /* Smooth animations */
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      #helix-chat-widget {
        animation: slideIn 0.3s ease-out;
      }

      /* HTMX Loading States */
      .htmx-settling .htmx-added.htmx-added {
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }

      .htmx-added.htmx-added {
        opacity: 1;
      }

      .htmx-indicator {
        display: none;
      }

      .htmx-request .htmx-indicator {
        display: block;
      }

      .htmx-request.htmx-settling .htmx-indicator {
        display: none;
      }
    </style>
    {% endif %}
  </body>
</html>
